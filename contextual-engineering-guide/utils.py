
"""
ç”¨äºæ ¼å¼åŒ–å’Œæ˜¾ç¤ºå¯¹è¯æ¶ˆæ¯çš„å®ç”¨å‡½æ•°æ¨¡å—ã€‚

è¯¥æ¨¡å—æä¾›å‡½æ•°ï¼Œä½¿ç”¨ `rich` åº“åœ¨æ§åˆ¶å°ä¸­ä»¥ç»“æ„åŒ–ä¸”ç¾è§‚çš„æ–¹å¼å‘ˆç°æ¶ˆæ¯å¯¹è±¡ã€‚
"""

# å¯¼å…¥å¿…è¦çš„æ ‡å‡†åº“
import json
# å¯¼å…¥ç±»å‹æç¤ºä»¥è·å¾—æ¸…æ™°çš„å‡½æ•°ç­¾å
from typing import Any, List

# ä» rich åº“å¯¼å…¥ç»„ä»¶ä»¥å¢å¼ºæ§åˆ¶å°è¾“å‡º
from rich.console import Console
from rich.panel import Panel

# åˆå§‹åŒ–ä¸€ä¸ªå…¨å±€çš„ rich åº“ Console å¯¹è±¡ã€‚
# è¯¥å¯¹è±¡å°†ç”¨äºæ‰€æœ‰åˆ°ç»ˆç«¯çš„æ ·å¼åŒ–è¾“å‡ºã€‚
console = Console()


def format_message_content(message: Any) -> str:
    """
    å°†æ¶ˆæ¯å¯¹è±¡çš„å†…å®¹è½¬æ¢ä¸ºå¯æ˜¾ç¤ºçš„å­—ç¬¦ä¸²ã€‚

    æ­¤å‡½æ•°å¤„ç†ç®€å•çš„å­—ç¬¦ä¸²å†…å®¹ä»¥åŠå¤æ‚çš„åŸºäºåˆ—è¡¨çš„å†…å®¹ï¼ˆå¦‚å·¥å…·è°ƒç”¨ï¼‰ï¼Œ
    é€šè¿‡é€‚å½“åœ°è§£æå’Œæ ¼å¼åŒ–å®ƒä»¬ã€‚

    å‚æ•°:
        message: ä¸€ä¸ªå…·æœ‰ 'content' å±æ€§çš„æ¶ˆæ¯å¯¹è±¡ã€‚

    è¿”å›:
        æ¶ˆæ¯å†…å®¹çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²è¡¨ç¤ºã€‚
    """
    # ä»æ¶ˆæ¯å¯¹è±¡ä¸­æ£€ç´¢å†…å®¹ã€‚
    content = message.content

    # æ£€æŸ¥å†…å®¹æ˜¯å¦ä¸ºç®€å•å­—ç¬¦ä¸²ã€‚
    if isinstance(content, str):
        # å¦‚æœæ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚
        return content
    # æ£€æŸ¥å†…å®¹æ˜¯å¦ä¸ºåˆ—è¡¨ï¼Œè¿™é€šå¸¸è¡¨ç¤ºå¤æ‚æ•°æ®ï¼Œå¦‚å·¥å…·è°ƒç”¨ã€‚
    elif isinstance(content, list):
        # åˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨ä»¥ä¿å­˜å†…å®¹çš„æ ¼å¼åŒ–éƒ¨åˆ†ã€‚
        parts = []
        # éå†å†…å®¹åˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹ã€‚
        for item in content:
            # å¦‚æœé¡¹ç›®æ˜¯ç®€å•çš„æ–‡æœ¬å—ã€‚
            if item.get("type") == "text":
                # ç›´æ¥å°†æ–‡æœ¬é™„åŠ åˆ°æˆ‘ä»¬çš„ parts åˆ—è¡¨ä¸­ã€‚
                parts.append(item["text"])
            # å¦‚æœé¡¹ç›®è¡¨ç¤ºæ­£åœ¨ä½¿ç”¨çš„å·¥å…·ã€‚
            elif item.get("type") == "tool_use":
                # æ ¼å¼åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²ä»¥æŒ‡ç¤ºå·¥å…·è°ƒç”¨ï¼ŒåŒ…æ‹¬å·¥å…·çš„åç§°ã€‚
                tool_call_str = f"\nğŸ”§ å·¥å…·è°ƒç”¨: {item.get('name')}"
                # å°†å·¥å…·çš„è¾“å…¥å‚æ•°æ ¼å¼åŒ–ä¸ºç¾è§‚çš„ JSON å­—ç¬¦ä¸²ã€‚
                tool_args_str = f"   å‚æ•°: {json.dumps(item.get('input', {}), indent=2)}"
                # å°†æ ¼å¼åŒ–çš„å·¥å…·è°ƒç”¨å­—ç¬¦ä¸²æ·»åŠ åˆ°æˆ‘ä»¬çš„ parts åˆ—è¡¨ä¸­ã€‚
                parts.extend([tool_call_str, tool_args_str])
        # å°†æ‰€æœ‰æ ¼å¼åŒ–çš„éƒ¨åˆ†è¿æ¥æˆä¸€ä¸ªå•ä¸€çš„å­—ç¬¦ä¸²ï¼Œç”¨æ¢è¡Œç¬¦åˆ†éš”ã€‚
        return "\n".join(parts)
    # å¯¹äºä»»ä½•å…¶ä»–ç±»å‹çš„å†…å®¹ã€‚
    else:
        # å°†å†…å®¹è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä½œä¸ºåå¤‡æ–¹æ¡ˆã€‚
        return str(content)


def format_messages(messages: List[Any]) -> None:
    """
    ä½¿ç”¨ rich Panel æ ¼å¼åŒ–å¹¶æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨ã€‚

    æ¯æ¡æ¶ˆæ¯éƒ½åœ¨ä¸€ä¸ªå¸¦æ ·å¼çš„é¢æ¿å†…å‘ˆç°ï¼Œå…¶æ ‡é¢˜å’Œè¾¹æ¡†é¢œè‰²
    ä¸å…¶è§’è‰²ï¼ˆä¾‹å¦‚ï¼Œäººç±»ã€AIã€å·¥å…·ï¼‰ç›¸å¯¹åº”ã€‚

    å‚æ•°:
        messages: è¦æ˜¾ç¤ºçš„æ¶ˆæ¯å¯¹è±¡åˆ—è¡¨ã€‚
    """
    # éå†æä¾›çš„åˆ—è¡¨ä¸­çš„æ¯ä¸ªæ¶ˆæ¯å¯¹è±¡ã€‚
    for m in messages:
        # é€šè¿‡è·å–ç±»åå¹¶åˆ é™¤â€œMessageâ€æ¥ç¡®å®šæ¶ˆæ¯ç±»å‹ã€‚
        msg_type = m.__class__.__name__.replace("Message", "")
        # ä½¿ç”¨æˆ‘ä»¬çš„è¾…åŠ©å‡½æ•°è·å–æ¶ˆæ¯çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å†…å®¹ã€‚
        content = format_message_content(m)

        # å®šä¹‰ rich Panel çš„é»˜è®¤å‚æ•°ã€‚
        panel_args = {"title": f"{msg_type}", "border_style": "white"}

        # æ ¹æ®æ¶ˆæ¯ç±»å‹è‡ªå®šä¹‰é¢æ¿å¤–è§‚ã€‚
        # å¦‚æœæ¶ˆæ¯æ¥è‡ªäººç±»ç”¨æˆ·ã€‚
        if msg_type == "Human":
            # æ›´æ–°æ ‡é¢˜å¹¶å°†è¾¹æ¡†é¢œè‰²è®¾ç½®ä¸ºè“è‰²ã€‚
            panel_args.update(title="äººç±»", border_style="blue")
        # å¦‚æœæ¶ˆæ¯æ¥è‡ª AI åŠ©æ‰‹ã€‚
        elif msg_type == "Ai":
            # æ›´æ–°æ ‡é¢˜å¹¶å°†è¾¹æ¡†é¢œè‰²è®¾ç½®ä¸ºç»¿è‰²ã€‚
            panel_args.update(title="åŠ©æ‰‹", border_style="green")
        # å¦‚æœæ¶ˆæ¯æ˜¯å·¥å…·çš„è¾“å‡ºã€‚
        elif msg_type == "Tool":
            # æ›´æ–°æ ‡é¢˜å¹¶å°†è¾¹æ¡†é¢œè‰²è®¾ç½®ä¸ºé»„è‰²ã€‚
            panel_args.update(title="å·¥å…·è¾“å‡º", border_style="yellow")

        # ä½¿ç”¨æ ¼å¼åŒ–çš„å†…å®¹å’Œè‡ªå®šä¹‰å‚æ•°åˆ›å»ºä¸€ä¸ª Panelã€‚
        # ç„¶åï¼Œå°†é¢æ¿æ‰“å°åˆ°æ§åˆ¶å°ã€‚
        console.print(Panel(content, **panel_args))


def format_message(messages: List[Any]) -> None:
    """
    format_messages å‡½æ•°çš„åˆ«åã€‚

    è¿™ä¸ºä»»ä½•å¯èƒ½ä»åœ¨ä½¿ç”¨å•æ•°åç§° `format_message` çš„ä»£ç 
    æä¾›äº†å‘åå…¼å®¹æ€§ã€‚

    å‚æ•°:
        messages: è¦æ˜¾ç¤ºçš„æ¶ˆæ¯å¯¹è±¡åˆ—è¡¨ã€‚
    """
    # è°ƒç”¨ä¸» format_messages å‡½æ•°æ¥æ‰§è¡Œæ¸²æŸ“ã€‚
    format_messages(messages)
